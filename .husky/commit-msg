#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

CURRENT_BRANCH_NAME=$(git symbolic-ref --short HEAD)

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(awk '!/^\s*#/' "$COMMIT_MSG_FILE")
SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')

IS_HEADER_LENGTH_UNDER_50='^(.{1,50}$)'
IS_INCLUDE_A_TYPE='(\[Daily]|\[Meeting])'
IS_LEVEL_VALID='( \/ )((level [1-5])|(Unrated)|(Bronze)|(Silver)|(Gold)|(Platinum)|(Diamond)|(Ruby))'

# --- ì´ˆê¸° ì˜ˆì™¸ì²˜ë¦¬ ---
if [[ $CURRENT_BRANCH_NAME == "main" ]] || [[ $COMMIT_MSG =~ Merge ]] || [[ $COMMIT_MSG =~ \[Fix\] ]]; then
    exit 0
elif [[ $COMMIT_MSG =~ (\[Meeting\] Update (README|Readme)) ]]; then
    exit 0
fi

if [[ "$CURRENT_BRANCH_NAME" =~ meeting ]] && [[ ! $COMMIT_MSG =~ \[Meeting\] ]]; then
    echo "ğŸš¨ /meeting branchì—ì„œëŠ” [Meeting] type ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."
    echo "$CURRENT_BRANCH_NAME"
    echo "$COMMIT_MSG"
    exit 1
fi

# --- header ---
if ! grep -qP "$IS_HEADER_LENGTH_UNDER_50" "$COMMIT_MSG_FILE"; then
    echo "ğŸš¨ HeaderëŠ” 50ìë¥¼ ë„˜ì„ ìˆ˜ ì—†ì–´ìš”."
    echo "$COMMIT_MSG"
    echo "$SECOND_LINE"
    exit 1
fi

if ! grep -qP "$IS_INCLUDE_A_TYPE" "$COMMIT_MSG_FILE"; then
    echo "ğŸš¨ Commit Typeì€ [Daily] ë˜ëŠ” [Meeting] ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•´ìš”."
    echo "$COMMIT_MSG"
    echo "$SECOND_LINE"
    exit 1
fi

if ! grep -qP "$IS_LEVEL_VALID" "$COMMIT_MSG_FILE"; then
    echo "ğŸš¨ / level (1|2|3|4|5) í˜•ì‹ìœ¼ë¡œ ì…ë ¥ í•´ ì£¼ì„¸ìš”. (ë„ì–´ì“°ê¸°ë„ í¬í•¨ì´ì—ìš”!)"
    echo "$COMMIT_MSG"
    echo "$SECOND_LINE"
    exit 1
fi

# --- description ---
if ! [ -z "$SECOND_LINE" ]; then
  echo "ğŸš¨ ë‘ ë²ˆì§¸ ì¤„ì€ ë¹„ì›Œë‘¬ì•¼ í•´ìš”."
  echo "$COMMIT_MSG"
  exit 1
fi

